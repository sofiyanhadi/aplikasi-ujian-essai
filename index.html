<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Ujian Esai AI (Generator Link)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .prose-custom { max-width: none; }
        .prose-custom p { margin-top: 0.5em; margin-bottom: 0.5em; }
        .prose-custom h3 { margin-bottom: 0.5em; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 40; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; }
        #pdf-render-area {
            position: absolute;
            left: -9999px;
            top: 0;
            background: white;
            padding: 20px;
            width: 210mm; /* A4 width */
        }
        .toolbar-btn {
            padding: 4px 10px;
            border-radius: 6px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .toolbar-btn:hover {
            background-color: #e0e0e0;
        }
        /* Style untuk input yang dikunci/readonly */
        input:read-only {
            background-color: #f3f4f6;
            cursor: not-allowed;
            opacity: 0.7;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-4xl bg-white rounded-2xl shadow-xl p-6 md:p-8 relative overflow-hidden">
        
        <button id="teacher-settings-btn" class="absolute top-4 right-4 text-gray-500 hover:text-blue-600 transition-colors" title="Pengaturan Guru">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
        </button>

        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Ujian Esai Otomatis</h1>
            <p class="text-gray-500 mt-1">Ditenagai oleh AI untuk Koreksi Cerdas</p>
        </div>

        <div id="start-screen">
            <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg mb-6">
                <p class="font-bold">Selamat Datang!</p>
                <p>Silakan lengkapi identitas Anda untuk memulai ujian. Jawablah setiap pertanyaan dengan lengkap.</p>
            </div>
             <div class="bg-yellow-50 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg mb-6">
                <p class="font-bold">Perhatian Penting!</p>
                <p>Selama ujian berlangsung, Anda **dilarang** untuk beralih ke tab lain, membuka jendela baru, atau meninggalkan halaman ini. Setiap pelanggaran akan menyebabkan ujian dihentikan secara otomatis.</p>
            </div>
            <div class="space-y-4">
                <input type="text" id="exam-subject" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Mata Pelajaran (e.g., Bahasa Indonesia)">
                <input type="text" id="student-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Nama Lengkap Anda">
                <input type="text" id="student-class" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Kelas (e.g., X-A)">
                <button id="start-quiz-btn" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition-all duration-300 shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Mulai Ujian
                </button>
            </div>
            <div id="start-error" class="text-red-500 mt-2 text-center"></div>
        </div>

        <div id="quiz-screen" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 id="question-counter" class="text-xl font-semibold text-gray-700"></h2>
                <div id="timer-display" class="text-xl font-bold text-red-600 bg-red-50 border border-red-200 px-3 py-1 rounded-lg"></div>
                <div id="student-info" class="text-right text-sm text-gray-600"></div>
            </div>
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 min-h-[120px]">
                <p id="question-text" class="text-lg text-gray-800 leading-relaxed"></p>
            </div>
            <div class="mt-4">
                <div id="writing-toolbar" class="flex flex-wrap gap-2 mb-2 p-2 bg-gray-100 rounded-lg border">
                    <button type="button" class="toolbar-btn" data-char="²">x²</button>
                    <button type="button" class="toolbar-btn" data-char="³">x³</button>
                    <button type="button" class="toolbar-btn" data-char="√">√</button>
                    <button type="button" class="toolbar-btn" data-char="÷">÷</button>
                    <button type="button" class="toolbar-btn" data-char="×">×</button>
                    <button type="button" class="toolbar-btn" data-char="°">°</button>
                    <button type="button" class="toolbar-btn" data-char="Δ">Δ</button>
                    <button type="button" class="toolbar-btn" data-char="π">π</button>
                    <button type="button" class="toolbar-btn" data-char="θ">θ</button>
                    <button type="button" class="toolbar-btn" data-char="±">±</button>
                    <button type="button" class="toolbar-btn" data-char="≥">≥</button>
                    <button type="button" class="toolbar-btn" data-char="≤">≤</button>
                </div>
                <textarea id="student-answer" class="w-full px-4 py-3 border border-gray-300 rounded-lg h-40 resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Tulis jawaban Anda di sini..."></textarea>
            </div>
            <div class="mt-4">
                <button id="submit-answer-btn" class="w-full bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700 transition-all duration-300 shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    Kirim Jawaban
                </button>
                <div id="grading-loader" class="hidden text-center mt-4 text-blue-600 font-medium">
                    <div class="flex justify-center items-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        AI sedang mengoreksi jawaban Anda...
                    </div>
                </div>
            </div>
        </div>

        <div id="results-screen" class="hidden">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Hasil Ujian: <span id="result-student-name"></span></h2>
                <p id="result-class-subject" class="text-gray-600"></p>
                <p class="text-5xl font-extrabold text-blue-600 mt-2" id="total-score"></p>
                <p class="text-gray-500">Skor Rata-rata</p>
            </div>
            <div id="results-details" class="space-y-4 max-h-[40vh] overflow-y-auto pr-2"></div>
            <p id="save-status" class="text-center text-sm text-gray-500 mt-4"></p>
            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="download-pdf-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-all duration-300 shadow-md flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                    Unduh Hasil (PDF)
                </button>
                <button id="retake-quiz-btn" class="w-full bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-gray-700 transition-all duration-300 shadow-md">
                    Ulangi Ujian
                </button>
            </div>
        </div>
        
        <footer class="text-center text-sm text-gray-500 mt-8 pt-4 border-t border-gray-200">
            <p class="flex items-center justify-center gap-1.5">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                </svg>
                Innovation maker : Sofiyan Hadi <span class="ml-2 font-semibold">v1.2</span>
            </p>
        </footer>
    </div>

    <div id="settings-backdrop" class="modal-backdrop"></div>
    <div id="settings-modal" class="modal w-11/12 max-w-lg bg-white rounded-xl shadow-2xl p-6">
        <div id="pin-section">
            <h3 class="text-xl font-bold text-center mb-4">Mode Guru</h3>
            <p class="text-center text-gray-600 mb-4">Masukkan PIN untuk mengakses pengaturan.</p>
            <input type="password" id="teacher-pin" class="w-full px-4 py-2 border rounded-lg text-center" placeholder="****">
            <button id="submit-pin-btn" class="mt-4 w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Masuk</button>
            <p id="pin-error" class="text-red-500 text-center mt-2 text-sm"></p>
        </div>
        
        <div id="settings-section" class="hidden">
             <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Pembuat Link Ujian</h3>
                <button id="close-settings-btn" class="text-gray-500 hover:text-red-600 text-3xl font-bold">&times;</button>
            </div>
            <div class="space-y-4">
                 <div>
                    <label for="teacher-name-config" class="block text-sm font-medium text-gray-700">Nama Guru (untuk PDF)</label>
                    <input type="text" id="teacher-name-config" class="mt-1 w-full px-3 py-2 border rounded-md" placeholder="Contoh: Budi Santoso, S.Pd.">
                </div>
                <div>
                    <label for="exam-material-config" class="block text-sm font-medium text-gray-700">Materi Ujian (Nama Mapel)</label>
                    <input type="text" id="exam-material-config" class="mt-1 w-full px-3 py-2 border rounded-md" placeholder="Contoh: Matematika - Bab Turunan">
                </div>
                <div>
                    <label for="exam-duration-config" class="block text-sm font-medium text-gray-700">Durasi Ujian (menit)</label>
                    <input type="number" id="exam-duration-config" class="mt-1 w-full px-3 py-2 border rounded-md" placeholder="Kosongkan untuk tanpa batas waktu" min="0">
                </div>
                <div>
                    <label for="sheet-url-config" class="block text-sm font-medium text-gray-700">URL Google Sheet (Untuk Soal)</label>
                    <input type="text" id="sheet-url-config" class="mt-1 w-full px-3 py-2 border rounded-md" placeholder="https://docs.google.com/spreadsheets/d/...">
                </div>
                <div>
                    <label for="apps-script-url-config" class="block text-sm font-medium text-gray-700">URL Google Apps Script (Untuk Hasil)</label>
                    <input type="text" id="apps-script-url-config" class="mt-1 w-full px-3 py-2 border rounded-md" placeholder="https://script.google.com/macros/s/.../exec">
                </div>
                <div class="border-t pt-4">
                    <label for="gemini-api-key-config" class="block text-sm font-medium text-gray-700">Gemini API Key (Hanya disimpan di browser ini)</label>
                    <input type="password" id="gemini-api-key-config" class="mt-1 w-full px-3 py-2 border rounded-md" placeholder="Masukkan API Key Gemini Anda">
                </div>
            </div>
            <div class="mt-6 flex justify-between space-x-3">
                 <button id="save-api-key-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Simpan API Key Lokal</button>
                 <button id="generate-link-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Buat Link Ujian</button>
            </div>
            
             <div id="generated-link-container" class="hidden mt-4">
                <label class="block text-sm font-medium text-gray-700">Link Ujian (Bagikan ke Siswa):</label>
                <textarea id="generated-link-output" class="w-full h-24 p-2 border rounded-md mt-1 bg-gray-50" readonly></textarea>
                <button id="copy-link-btn" class="mt-2 w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">Salin Link</button>
            </div>

            <div class="mt-4 border-t pt-4">
                 <button id="reset-settings-btn" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Reset API Key Lokal</button>
                 <p class="text-xs text-gray-500 text-center mt-2">Hanya mereset API Key yang tersimpan di browser ini.</p>
            </div>
        </div>
    </div>
    
    <div id="cheat-backdrop" class="modal-backdrop"></div>
    <div id="cheat-modal" class="modal w-11/12 max-w-md bg-white rounded-xl shadow-2xl p-6 text-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-red-500" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" />
        </svg>
        <h3 class="text-xl font-bold text-gray-800 mt-4">Ujian Dihentikan!</h3>
        <p class="text-gray-600 mt-2">Aktivitas di luar jendela ujian terdeteksi. Sesuai peraturan, ujian Anda telah dihentikan secara otomatis.</p>
        <button id="close-cheat-modal-btn" class="mt-6 w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700">Lihat Hasil</button>
    </div>

    <div id="pdf-render-area"></div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const TEACHER_PIN = "1234";

        // --- Element Selectors ---
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const studentNameInput = document.getElementById('student-name');
        const studentClassInput = document.getElementById('student-class');
        const examSubjectInput = document.getElementById('exam-subject');
        const startError = document.getElementById('start-error');
        
        const questionCounter = document.getElementById('question-counter');
        const studentInfo = document.getElementById('student-info');
        const questionText = document.getElementById('question-text');
        const studentAnswerInput = document.getElementById('student-answer');
        const submitAnswerBtn = document.getElementById('submit-answer-btn');
        const gradingLoader = document.getElementById('grading-loader');
        const writingToolbar = document.getElementById('writing-toolbar');
        const timerDisplay = document.getElementById('timer-display');

        const resultStudentName = document.getElementById('result-student-name');
        const resultClassSubject = document.getElementById('result-class-subject');
        const totalScoreEl = document.getElementById('total-score');
        const resultsDetails = document.getElementById('results-details');
        const retakeQuizBtn = document.getElementById('retake-quiz-btn');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const saveStatus = document.getElementById('save-status');

        const teacherSettingsBtn = document.getElementById('teacher-settings-btn');
        const settingsBackdrop = document.getElementById('settings-backdrop');
        const settingsModal = document.getElementById('settings-modal');
        const pinSection = document.getElementById('pin-section');
        const teacherPinInput = document.getElementById('teacher-pin');
        const submitPinBtn = document.getElementById('submit-pin-btn');
        const pinError = document.getElementById('pin-error');
        const settingsSection = document.getElementById('settings-section');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        
        // --- SELEKTOR BARU UNTUK PANEL GURU (Config) ---
        const teacherNameConfig = document.getElementById('teacher-name-config');
        const examMaterialConfig = document.getElementById('exam-material-config');
        const examDurationConfig = document.getElementById('exam-duration-config');
        const sheetUrlConfig = document.getElementById('sheet-url-config');
        const geminiApiKeyConfig = document.getElementById('gemini-api-key-config');
        const appsScriptUrlConfig = document.getElementById('apps-script-url-config');
        
        const generateLinkBtn = document.getElementById('generate-link-btn');
        const saveApiKeyBtn = document.getElementById('save-api-key-btn');
        const generatedLinkContainer = document.getElementById('generated-link-container');
        const generatedLinkOutput = document.getElementById('generated-link-output');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        const resetSettingsBtn = document.getElementById('reset-settings-btn'); 
        // --- AKHIR SELEKTOR BARU ---

        const cheatBackdrop = document.getElementById('cheat-backdrop');
        const cheatModal = document.getElementById('cheat-modal');
        const closeCheatModalBtn = document.getElementById('close-cheat-modal-btn');
        
        // --- State Variables ---
        let questions = [];
        let currentQuestionIndex = 0;
        let studentName = "", studentClass = "", examSubject = "";
        let studentAnswers = [];
        
        // --- PENGATURAN DEFAULT (FALLBACK) ---
        // Jika link dibuka tanpa parameter, ini yang akan digunakan.
        let settings = { 
            sheetUrl: "https://docs.google.com/spreadsheets/d/1XvwgOUD0DM1kMWKHbOfqkuckY7vIW5_E94sENKprnb0/edit", // Ganti dengan sheet default Anda
            geminiApiKey: "", // API Key HANYA disimpan lokal
            appsScriptUrl: "https://script.google.com/macros/s/AKfycbzocRCw2n9iK0KOzX88RQ2JewWslOotOC17x4NtWzr0g06MjKSvv0MMPGQG15GFMNriEA/exec", // Ganti dengan script default Anda
            teacherName: 'Guru Default',
            examMaterial: 'Ujian Umum', 
            examDuration: '60'
        };
        let isQuizActive = false;
        let timerInterval = null;

        // --- Helper Function ---
        const parseSheetUrl = (url) => {
            try {
                if (!url) return null;
                const match = url.match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                return match ? match[1] : null;
            } catch (error) { return null; }
        };

        // --- Settings Management (DIUBAH UNTUK GENERATOR LINK) ---
        const loadSettings = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const sheetIdFromUrl = urlParams.get('sheetId');
            const scriptUrlFromUrl = urlParams.get('scriptUrl');
            const teacherFromUrl = urlParams.get('teacher');
            const materialFromUrl = urlParams.get('material');
            const durationFromUrl = urlParams.get('duration');

            let activeSettings = { ...settings }; // Mulai dengan fallback settings

            // 1. Timpa dengan data dari localStorage (HANYA API KEY)
            const savedSettingsJSON = localStorage.getItem('quizAppSettings');
            if (savedSettingsJSON) {
                const savedSettings = JSON.parse(savedSettingsJSON);
                activeSettings.geminiApiKey = savedSettings.geminiApiKey || activeSettings.geminiApiKey;
            }
            
            // 2. Timpa dengan data dari URL jika ada (Prioritas tertinggi untuk ujian)
            if (sheetIdFromUrl) {
                activeSettings.sheetUrl = `https://docs.google.com/spreadsheets/d/${sheetIdFromUrl}/edit`;
                // Kunci/Setelan lain dari URL
                if (scriptUrlFromUrl) activeSettings.appsScriptUrl = decodeURIComponent(scriptUrlFromUrl);
                if (teacherFromUrl) activeSettings.teacherName = decodeURIComponent(teacherFromUrl);
                if (materialFromUrl) activeSettings.examMaterial = decodeURIComponent(materialFromUrl);
                if (durationFromUrl) activeSettings.examDuration = durationFromUrl;
                
                // LANGSUNG ISI FORM SISWA DAN KUNCI (READONLY)
                examSubjectInput.value = activeSettings.examMaterial || '';
                examSubjectInput.readOnly = true;
            }
            
            settings = activeSettings;

            // Tampilkan pengaturan yang aktif ke dalam form panel GURU
            sheetUrlConfig.value = settings.sheetUrl || '';
            appsScriptUrlConfig.value = settings.appsScriptUrl || '';
            geminiApiKeyConfig.value = settings.geminiApiKey || '';
            teacherNameConfig.value = settings.teacherName || '';
            examMaterialConfig.value = settings.examMaterial || '';
            examDurationConfig.value = settings.examDuration || '60';
        };

        // Fungsi untuk menyimpan API Key saja secara lokal
        const saveApiKeyLocal = () => {
            const settingsToSave = {
                geminiApiKey: geminiApiKeyConfig.value,
            };
            localStorage.setItem('quizAppSettings', JSON.stringify(settingsToSave));
            settings.geminiApiKey = geminiApiKeyConfig.value; // Perbarui state saat ini
            alert('API Key berhasil disimpan di browser ini!');
        };

        // Fungsi untuk membuat link ujian
        const generateExamLink = () => {
            const sheetUrl = sheetUrlConfig.value;
            const sheetId = parseSheetUrl(sheetUrl);
            const scriptUrl = appsScriptUrlConfig.value;
            const teacher = teacherNameConfig.value;
            const material = examMaterialConfig.value;
            const duration = examDurationConfig.value;

            if (!sheetId || !scriptUrl || !teacher || !material) {
                alert('Harap isi semua kolom untuk membuat link (Sheet URL, Script URL, Nama Guru, Materi).');
                return;
            }

            const baseUrl = window.location.href.split('?')[0];
            const params = new URLSearchParams();
            params.append('sheetId', sheetId);
            params.append('scriptUrl', encodeURIComponent(scriptUrl));
            params.append('teacher', encodeURIComponent(teacher));
            params.append('material', encodeURIComponent(material));
            if (duration && parseInt(duration, 10) > 0) {
                params.append('duration', duration);
            }

            const generatedLink = `${baseUrl}?${params.toString()}`;
            
            generatedLinkOutput.value = generatedLink;
            generatedLinkContainer.style.display = 'block';
        };

        // Fungsi untuk menyalin link
        const copyLinkToClipboard = () => {
            generatedLinkOutput.select(); // Pilih teks di textarea
            try {
                navigator.clipboard.writeText(generatedLinkOutput.value)
                    .then(() => {
                        alert('Link berhasil disalin!');
                    })
                    .catch(err => {
                        // Fallback jika Clipboard API gagal
                        document.execCommand('copy');
                        alert('Link berhasil disalin! (fallback)');
                    });
            } catch (err) {
                // Fallback jika Clipboard API tidak didukung
                document.execCommand('copy');
                alert('Link berhasil disalin! (fallback)');
            }
        };

        // Fungsi reset hanya untuk API Key lokal
        const resetLocalSettings = () => {
            if(confirm('Apakah Anda yakin ingin mereset API Key yang tersimpan di browser ini?')) {
                localStorage.removeItem('quizAppSettings');
                alert('API Key lokal berhasil direset. Harap muat ulang halaman jika ada masalah.');
                geminiApiKeyConfig.value = "";
                settings.geminiApiKey = "";
            }
        };

        const openSettingsModal = () => {
            // Muat ulang nilai dari state saat ini ke form config
            teacherNameConfig.value = settings.teacherName || '';
            examMaterialConfig.value = settings.examMaterial || '';
            examDurationConfig.value = settings.examDuration || '60';
            sheetUrlConfig.value = settings.sheetUrl || '';
            appsScriptUrlConfig.value = settings.appsScriptUrl || '';
            geminiApiKeyConfig.value = settings.geminiApiKey || '';
            
            generatedLinkContainer.style.display = 'none';
            generatedLinkOutput.value = '';

            settingsBackdrop.style.display = 'block';
            settingsModal.style.display = 'block';
            pinSection.style.display = 'block';
            settingsSection.style.display = 'none';
            teacherPinInput.value = '';
            pinError.textContent = '';
        };

        const closeSettingsModal = () => {
            settingsBackdrop.style.display = 'none';
            settingsModal.style.display = 'none';
        };

        const checkPin = () => {
            if (teacherPinInput.value === TEACHER_PIN) {
                pinSection.style.display = 'none';
                settingsSection.style.display = 'block';
            } else {
                pinError.textContent = 'PIN salah. Coba lagi.';
            }
        };

        // --- Exam Security, Timer, and Core Logic (No changes needed in logic) ---
        const handleCheatingAttempt = () => {
            if (!isQuizActive) return;
            isQuizActive = false; 
            removeRestrictionListeners();
            cheatBackdrop.style.display = 'block';
            cheatModal.style.display = 'block';
            // Hanya pindah ke results screen jika cheat modal ditutup
        };
        const handleVisibilityChange = () => {
            if (document.hidden && isQuizActive) {
                handleCheatingAttempt();
            }
        };
        const addRestrictionListeners = () => {
            window.addEventListener('blur', handleCheatingAttempt);
            document.addEventListener('visibilitychange', handleVisibilityChange);
        };
        const removeRestrictionListeners = () => {
            window.removeEventListener('blur', handleCheatingAttempt);
            document.removeEventListener('visibilitychange', handleVisibilityChange);
        };
        const startTimer = () => {
            if (timerInterval) clearInterval(timerInterval);
            const durationInMinutes = parseInt(settings.examDuration, 10);
            if (!durationInMinutes || durationInMinutes <= 0) {
                timerDisplay.textContent = 'Tanpa Waktu';
                return;
            }
            let timeLeftInSeconds = durationInMinutes * 60;
            const updateDisplay = () => {
                if (timeLeftInSeconds < 0) return;
                const minutes = Math.floor(timeLeftInSeconds / 60);
                const seconds = timeLeftInSeconds % 60;
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeftInSeconds <= 60 && timeLeftInSeconds > 0) {
                    timerDisplay.classList.add('animate-pulse');
                } else {
                    timerDisplay.classList.remove('animate-pulse');
                }
            };
            updateDisplay();
            timerInterval = setInterval(() => {
                timeLeftInSeconds--;
                updateDisplay();
                if (timeLeftInSeconds < 0) {
                    clearInterval(timerInterval);
                    timerDisplay.textContent = "Waktu Habis!";
                    showResults();
                }
            }, 1000);
        };
        const fetchQuestions = async () => {
            if (!settings.sheetUrl || !settings.geminiApiKey) {
                startError.textContent = 'Pengaturan Guru (URL Sheet dan API Key) belum lengkap. Cek panel Pengaturan.';
                return false;
            }
            const sheetId = parseSheetUrl(settings.sheetUrl);
            if (!sheetId) {
                startError.textContent = 'Format URL Google Sheet tidak valid. Pastikan Anda memasukkan URL "edit".';
                return false;
            }
            // Tambahkan parameter cb untuk mencegah caching
            const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=0&cb=${new Date().getTime()}`; 
            try {
                startQuizBtn.disabled = true;
                startQuizBtn.textContent = 'Memuat Soal...';
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error('Gagal mengambil data. Pastikan sheet sudah di-"publish ke web" (Opsi 1: Seluruh Dokumen) DAN akses link diatur ke "Siapa saja yang memiliki link".');
                const csvText = await response.text();
                const rows = csvText.split(/\r?\n/).slice(1);
                questions = rows.map(row => {
                    if (!row) return null;
                    // Regex untuk memecah CSV, mengabaikan koma di dalam tanda kutip
                    const columns = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    return {
                        question: (columns[0] || '').replace(/^"|"$/g, '').trim(),
                        keyAnswer: (columns[1] || '').replace(/^"|"$/g, '').trim()
                    };
                }).filter(q => q && q.question);
                if (questions.length === 0) throw new Error('Tidak ada soal yang ditemukan. Pastikan soal dan kunci ada di dua kolom pertama Sheet1.');
                // Acak soal
                for (let i = questions.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [questions[i], questions[j]] = [questions[j], questions[i]];
                }
                return true;
            } catch (error) {
                startError.textContent = `Error: ${error.message}`;
                return false;
            } finally {
                startQuizBtn.disabled = false;
                startQuizBtn.textContent = 'Mulai Ujian';
            }
        };

        const displayQuestion = () => {
            studentAnswerInput.value = '';
            studentInfo.innerHTML = `<strong>${studentName}</strong> (${studentClass})`;
            questionCounter.textContent = `Soal ${currentQuestionIndex + 1} dari ${questions.length}`;
            questionText.textContent = questions[currentQuestionIndex].question;
            studentAnswerInput.focus();
        };

        const startQuiz = async () => {
            studentName = studentNameInput.value.trim();
            studentClass = studentClassInput.value.trim();
            // examSubject diisi dari settings yang dimuat (dari URL atau default)
            examSubject = examSubjectInput.value.trim(); 
            if (!studentName || !studentClass || !examSubject) {
                startError.textContent = 'Semua kolom identitas harus diisi.';
                return;
            }
            startError.textContent = '';
            const questionsLoaded = await fetchQuestions();
            if (!questionsLoaded) return;
            isQuizActive = true;
            addRestrictionListeners();
            currentQuestionIndex = 0;
            studentAnswers = [];
            startScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            displayQuestion();
            startTimer();
        };

        const gradeAnswer = async (question, keyAnswer, studentAnswer) => {
            const apiKey = settings.geminiApiKey;
            if (!apiKey) {
                return { score: 0, feedback: "Error: API Key Gemini belum diatur." };
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
            const systemPrompt = `Anda adalah asisten guru AI yang menilai jawaban esai siswa. Berikan skor dari 0 hingga 100 dan berikan umpan balik singkat dan konstruktif (maksimal 3 kalimat). Jawaban Anda HARUS dalam format JSON.`;
            const userQuery = `Kunci Jawaban/Rubrik: "${keyAnswer}"\n\nJawaban Siswa: "${studentAnswer}"\n\nBerdasarkan informasi di atas, berikan skor dan umpan balik singkat.`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                config: {
                    systemInstruction: systemPrompt,
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: { score: { type: "NUMBER" }, feedback: { type: "STRING" } },
                        required: ["score", "feedback"]
                    },
                    temperature: 0.2 // Mengutamakan objektivitas
                }
            };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { 
                    const err = await response.json(); 
                    console.error('API Error Response:', err);
                    let errorMessage = "Terjadi kesalahan API yang tidak diketahui.";
                    if (err.error && err.error.message.includes('API key not valid')) {
                         errorMessage = "API Key Gemini tidak valid atau kuota habis.";
                    } else if (err.error && err.error.message) {
                        errorMessage = `Error API: ${err.error.message}`;
                    }
                    throw new Error(errorMessage); 
                }
                
                const result = await response.json();
                const jsonText = result.candidates[0]?.content?.parts[0]?.text;
                
                if (!jsonText) throw new Error("API tidak mengembalikan format JSON yang valid.");
                
                const parsedResult = JSON.parse(jsonText);
                return { 
                    score: Math.max(0, Math.min(100, parsedResult.score)), // Pastikan skor antara 0-100
                    feedback: parsedResult.feedback 
                };
            } catch (error) {
                console.error("Error saat mengoreksi jawaban:", error);
                return { score: 0, feedback: `Terjadi kesalahan saat mengoreksi jawaban: ${error.message}` };
            }
        };

        const submitAnswer = async () => {
            const studentAnswer = studentAnswerInput.value.trim();
            if (!studentAnswer) { alert('Jawaban tidak boleh kosong.'); return; }
            
            gradingLoader.classList.remove('hidden');
            submitAnswerBtn.disabled = true;
            studentAnswerInput.disabled = true;
            
            const currentQuestion = questions[currentQuestionIndex];
            const result = await gradeAnswer(currentQuestion.question, currentQuestion.keyAnswer, studentAnswer);
            
            studentAnswers.push({ 
                question: currentQuestion.question, 
                answer: studentAnswer, 
                score: result.score, 
                feedback: result.feedback 
            });
            
            gradingLoader.classList.add('hidden');
            submitAnswerBtn.disabled = false;
            studentAnswerInput.disabled = false;
            
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
                displayQuestion();
            } else {
                showResults();
            }
        };

        const saveResultsToSheet = async (averageScore) => {
            const defaultScriptUrl = "https://script.google.com/macros/s/AKfycbzocRCw2n9iK0KOzX88RQ2JewWslOotOC17x4NtWzr0g06MjKSvv0MMPGQG15GFMNriEA/exec";
            if (!settings.appsScriptUrl || settings.appsScriptUrl === defaultScriptUrl) {
                saveStatus.textContent = 'URL Apps Script belum diatur. Hasil tidak disimpan ke Spreadsheet.';
                saveStatus.className = 'text-center text-sm text-yellow-600 mt-4';
                return;
            }
            saveStatus.textContent = 'Menyimpan hasil ke Spreadsheet...';
            saveStatus.className = 'text-center text-sm text-gray-500 mt-4';
            
            const isCheating = !isQuizActive; // Status ujian dihentikan = curang
            const statusText = isCheating ? 'DIHENTIKAN (CURANG)' : 'SELESAI';

            const payload = {
                timestamp: new Date().toLocaleString('id-ID', { dateStyle: 'long', timeStyle: 'short' }),
                studentName: studentName,
                studentClass: studentClass,
                subject: examSubject, 
                material: settings.examMaterial,
                averageScore: averageScore,
                status: statusText,
                details: JSON.stringify(studentAnswers, null, 2)
            };
            try {
                // Fetch dengan mode no-cors untuk Apps Script
                await fetch(settings.appsScriptUrl, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });
                saveStatus.textContent = `Hasil (${statusText}) berhasil disimpan ke Spreadsheet.`;
                saveStatus.className = 'text-center text-sm text-green-600 mt-4';
            } catch (error) {
                console.error('Gagal menyimpan hasil:', error);
                saveStatus.textContent = `Gagal menyimpan hasil ke Spreadsheet. (${statusText})`;
                saveStatus.className = 'text-center text-sm text-red-600 mt-4';
            }
        };

        const showResults = () => {
            if (timerInterval) clearInterval(timerInterval);
            removeRestrictionListeners(); // Pastikan listener dihapus setelah ujian selesai/dihentikan
            // isQuizActive sudah diatur menjadi false jika ujian selesai/curang
            quizScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
            resultStudentName.textContent = studentName;
            resultClassSubject.textContent = `Kelas: ${studentClass} | Mapel: ${examSubject} | Materi: ${settings.examMaterial || 'Umum'}`;
            
            const totalScore = studentAnswers.reduce((sum, ans) => sum + ans.score, 0);
            const averageScore = studentAnswers.length > 0 ? Math.round(totalScore / studentAnswers.length) : 0;
            totalScoreEl.textContent = averageScore;
            
            resultsDetails.innerHTML = '';
            studentAnswers.forEach((ans, index) => {
                const scoreColor = ans.score >= 75 ? 'bg-green-100 border-green-500' : ans.score >= 50 ? 'bg-yellow-100 border-yellow-500' : 'bg-red-100 border-red-500';
                resultsDetails.innerHTML += `<div class="p-4 rounded-lg border-l-4 prose-custom ${scoreColor}"><h3 class="font-semibold text-gray-800">Soal ${index + 1}</h3><p class="text-gray-700">${ans.question}</p><p class="mt-2 p-2 bg-gray-50 rounded text-gray-600"><strong>Jawaban Anda:</strong> ${ans.answer}</p><div class="mt-2 pt-2 border-t"><p class="font-bold">Skor: <span class="text-blue-700">${ans.score}</span> | Umpan Balik AI:</p><p class="text-sm italic text-gray-800">${ans.feedback}</p></div></div>`;
            });
            saveResultsToSheet(averageScore);
        };

        const downloadResultsAsPDF = async () => {
            const { jsPDF } = window.jspdf;
            const pdfRenderArea = document.getElementById('pdf-render-area');
            const resultsClone = document.getElementById('results-screen').cloneNode(true);
            
            // Hapus tombol dan status yang tidak perlu di PDF
            resultsClone.querySelector('#save-status').remove();
            resultsClone.querySelector('.grid').remove();
            resultsClone.querySelector('#results-details').style.maxHeight = 'none';
            resultsClone.querySelector('#results-details').style.overflowY = 'visible';

            // Tambahkan tanda tangan
            const signatureDiv = document.createElement('div');
            signatureDiv.style.marginTop = '40px';
            signatureDiv.style.textAlign = 'right';
            signatureDiv.style.fontSize = '12px';
            signatureDiv.style.width = '100%';
            signatureDiv.innerHTML = `<div style="float: right; width: 200px;"><p>Lumajang, ${new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p><p>Mengetahui,</p><p>Guru Mata Pelajaran</p><div style="height: 60px;"></div><p style="text-decoration: underline;"><strong>${settings.teacherName || '(..............................)'}</strong></p></div><div style="clear: both;"></div>`;
            resultsClone.appendChild(signatureDiv);

            pdfRenderArea.innerHTML = '';
            pdfRenderArea.appendChild(resultsClone);
            downloadPdfBtn.disabled = true;
            downloadPdfBtn.innerHTML = 'Membuat PDF...';
            
            try {
                const canvas = await html2canvas(pdfRenderArea, { scale: 2, useCORS: true });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const imgProps = pdf.getImageProperties(imgData);
                const ratio = imgProps.height / imgProps.width;
                const finalImgWidth = pdfWidth - 20; // 10mm margin each side
                let finalImgHeight = finalImgWidth * ratio;
                let heightLeft = finalImgHeight;
                let position = 10;
                
                pdf.addImage(imgData, 'PNG', 10, position, finalImgWidth, finalImgHeight);
                heightLeft -= (pdf.internal.pageSize.getHeight() - 20); // Kurangi dengan tinggi halaman dikurangi margin
                
                while (heightLeft > 0) {
                    position = 10 - finalImgHeight + heightLeft;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 10, position, finalImgWidth, finalImgHeight);
                    heightLeft -= (pdf.internal.pageSize.getHeight() - 20);
                }
                pdf.save(`Hasil Ujian ${examSubject} - ${studentName}.pdf`);
            } catch (error) {
                console.error("Gagal membuat PDF:", error);
                alert("Maaf, terjadi kesalahan saat membuat file PDF.");
            } finally {
                pdfRenderArea.innerHTML = '';
                downloadPdfBtn.disabled = false;
                downloadPdfBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg> Unduh Hasil (PDF)';
            }
        };


        // --- Event Listeners ---
        retakeQuizBtn.addEventListener('click', () => window.location.reload());
        startQuizBtn.addEventListener('click', startQuiz);
        submitAnswerBtn.addEventListener('click', submitAnswer);
        downloadPdfBtn.addEventListener('click', downloadResultsAsPDF);
        teacherSettingsBtn.addEventListener('click', openSettingsModal);
        closeSettingsBtn.addEventListener('click', closeSettingsModal);
        settingsBackdrop.addEventListener('click', closeSettingsModal);
        submitPinBtn.addEventListener('click', checkPin);
        
        // --- Event Listener Baru untuk Mode Generator Link ---
        saveApiKeyBtn.addEventListener('click', saveApiKeyLocal);
        generateLinkBtn.addEventListener('click', generateExamLink);
        copyLinkBtn.addEventListener('click', copyLinkToClipboard);
        resetSettingsBtn.addEventListener('click', resetLocalSettings);
        // --- AKHIR Event Listener Baru ---
        
        closeCheatModalBtn.addEventListener('click', () => {
            cheatBackdrop.style.display = 'none';
            cheatModal.style.display = 'none';
            // Paksa tampilkan hasil setelah menutup cheat modal
            quizScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
            showResults(); 
        });

        writingToolbar.addEventListener('click', (e) => {
            if (e.target.matches('.toolbar-btn')) {
                const char = e.target.dataset.char;
                const start = studentAnswerInput.selectionStart;
                const end = studentAnswerInput.selectionEnd;
                const text = studentAnswerInput.value;
                // Memasukkan karakter pada posisi kursor
                studentAnswerInput.value = text.substring(0, start) + char + text.substring(end);
                studentAnswerInput.focus();
                // Memindahkan kursor setelah karakter yang disisipkan
                studentAnswerInput.selectionEnd = start + char.length; 
            }
        });

        // --- Initial Load ---
        loadSettings();
    });
</script>
</body>
</html>
