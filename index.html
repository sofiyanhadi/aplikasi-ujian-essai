<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Ujian Esai AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .prose-custom { max-width: none; }
        .prose-custom p { margin-top: 0.5em; margin-bottom: 0.5em; }
        .prose-custom h3 { margin-bottom: 0.5em; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 40; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; }
        #pdf-render-area {
            position: absolute;
            left: -9999px;
            top: 0;
            background: white;
            padding: 20px;
            width: 210mm; /* A4 width */
        }
        .toolbar-btn {
            padding: 4px 10px;
            border-radius: 6px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .toolbar-btn:hover {
            background-color: #e0e0e0;
        }
        /* Style untuk input yang dikunci/readonly */
        input:read-only {
            background-color: #f3f4f6;
            cursor: not-allowed;
            opacity: 0.7;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-4xl bg-white rounded-2xl shadow-xl p-6 md:p-8 relative overflow-hidden">
        
        <button id="teacher-settings-btn" class="absolute top-4 right-4 text-gray-500 hover:text-blue-600 transition-colors" title="Pengaturan Guru">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
        </button>

        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Ujian Esai Otomatis</h1>
            <p class="text-gray-500 mt-1">Ditenagai oleh AI untuk Koreksi Cerdas</p>
        </div>

        <div id="start-screen">
            <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg mb-6">
                <p class="font-bold">Selamat Datang!</p>
                <p>Silakan lengkapi identitas Anda untuk memulai ujian. Jawablah setiap pertanyaan dengan lengkap.</p>
            </div>
             <div class="bg-yellow-50 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg mb-6">
                 <p class="font-bold">Perhatian Penting!</p>
                 <p>Selama ujian berlangsung, Anda **dilarang** untuk beralih ke tab lain, membuka jendela baru, atau meninggalkan halaman ini. Setiap pelanggaran akan menyebabkan ujian dihentikan secara otomatis.</p>
             </div>
            <div class="space-y-4">
                <input type="text" id="exam-subject" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Mata Pelajaran (e.g., Bahasa Indonesia)">
                <input type="text" id="student-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Nama Lengkap Anda">
                <input type="text" id="student-class" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Kelas (e.g., X-A)">
                <button id="start-quiz-btn" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition-all duration-300 shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Mulai Ujian
                </button>
            </div>
            <div id="start-error" class="text-red-500 mt-2 text-center"></div>
        </div>

        <div id="quiz-screen" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 id="question-counter" class="text-xl font-semibold text-gray-700"></h2>
                <div id="timer-display" class="text-xl font-bold text-red-600 bg-red-50 border border-red-200 px-3 py-1 rounded-lg"></div>
                <div id="student-info" class="text-right text-sm text-gray-600"></div>
            </div>
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 min-h-[120px]">
                <p id="question-text" class="text-lg text-gray-800 leading-relaxed"></p>
            </div>
            <div class="mt-4">
                <div id="writing-toolbar" class="flex flex-wrap gap-2 mb-2 p-2 bg-gray-100 rounded-lg border">
                    <button type="button" class="toolbar-btn" data-char="²">x²</button>
                    <button type="button" class="toolbar-btn" data-char="³">x³</button>
                    <button type="button" class="toolbar-btn" data-char="√">√</button>
                    <button type="button" class="toolbar-btn" data-char="÷">÷</button>
                    <button type="button" class="toolbar-btn" data-char="×">×</button>
                    <button type="button" class="toolbar-btn" data-char="°">°</button>
                    <button type="button" class="toolbar-btn" data-char="Δ">Δ</button>
                    <button type="button" class="toolbar-btn" data-char="π">π</button>
                    <button type="button" class="toolbar-btn" data-char="θ">θ</button>
                    <button type="button" class="toolbar-btn" data-char="±">±</button>
                    <button type="button" class="toolbar-btn" data-char="≥">≥</button>
                    <button type="button" class="toolbar-btn" data-char="≤">≤</button>
                </div>
                <textarea id="student-answer" class="w-full px-4 py-3 border border-gray-300 rounded-lg h-40 resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Tulis jawaban Anda di sini..."></textarea>
            </div>
            <div class="mt-4">
                <button id="submit-answer-btn" class="w-full bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700 transition-all duration-300 shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    Kirim Jawaban
                </button>
                <div id="grading-loader" class="hidden text-center mt-4 text-blue-600 font-medium">
                    <div class="flex justify-center items-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        AI sedang mengoreksi jawaban Anda...
                    </div>
                </div>
            </div>
        </div>

        <div id="results-screen" class="hidden">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Hasil Ujian: <span id="result-student-name"></span></h2>
                <p id="result-class-subject" class="text-gray-600"></p>
                <p class="text-5xl font-extrabold text-blue-600 mt-2" id="total-score"></p>
                <p class="text-gray-500">Skor Rata-rata</p>
            </div>
            <div id="results-details" class="space-y-4 max-h-[40vh] overflow-y-auto pr-2"></div>
            <p id="save-status" class="text-center text-sm text-gray-500 mt-4"></p>
            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="download-pdf-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-all duration-300 shadow-md flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                    Unduh Hasil (PDF)
                </button>
                <button id="retake-quiz-btn" class="w-full bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-gray-700 transition-all duration-300 shadow-md">
                    Ulangi Ujian
                </button>
            </div>
        </div>
        
        <footer class="text-center text-sm text-gray-500 mt-8 pt-4 border-t border-gray-200">
            <p class="flex items-center justify-center gap-1.5">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                     <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                 </svg>
                 Innovation maker : Sofiyan Hadi <span class="ml-2 font-semibold">v1.2</span>
            </p>
        </footer>
    </div>

    <div id="settings-backdrop" class="modal-backdrop"></div>
    <div id="settings-modal" class="modal w-11/12 max-w-lg bg-white rounded-xl shadow-2xl p-6">
        <div id="pin-section">
            <h3 class="text-xl font-bold text-center mb-4">Mode Guru</h3>
            <p class="text-center text-gray-600 mb-4">Masukkan PIN untuk mengakses pengaturan.</p>
            <input type="password" id="teacher-pin" class="w-full px-4 py-2 border rounded-lg text-center" placeholder="****">
            <button id="submit-pin-btn" class="mt-4 w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Masuk</button>
            <p id="pin-error" class="text-red-500 text-center mt-2 text-sm"></p>
        </div>
        
        <div id="settings-section" class="hidden">
             <div class="flex justify-between items-center mb-4">
                 <h3 class="text-xl font-bold">Pembuat Link Ujian</h3>
                 <button id="close-settings-btn" class="text-gray-500 hover:text-red-600 text-3xl font-bold">&times;</button>
             </div>
             <div class="space-y-4">
                 <div>
                     <label for="teacher-name" class="block text-sm font-medium text-gray-700">Nama Guru (untuk PDF)</label>
                     <input type="text" id="teacher-name" class="mt-1 w-full px-3 py-2 border rounded-md" placeholder="Contoh: Budi Santoso, S.Pd.">
                 </div>
                 <div>
                     <label for="exam-material" class="block text-sm font-medium text-gray-700">Materi Ujian (Nama Mapel)</label>
                     <input type="text" id="exam-material" class="mt-1 w-full px-3 py-2 border rounded-md" placeholder="Contoh: Matematika - Bab 1">
                 </div>
                 <div>
                     <label for="exam-duration" class="block text-sm font-medium text-gray-700">Durasi Ujian (menit)</label>
                     <input type="number" id="exam-duration" class="mt-1 w-full px-3 py-2 border rounded-md" placeholder="Kosongkan untuk tanpa batas waktu" min="0">
                 </div>
                 <div>
                     <label for="sheet-url" class="block text-sm font-medium text-gray-700">URL Google Sheet (Untuk Soal)</label>
                     <input type="text" id="sheet-url" class="mt-1 w-full px-3 py-2 border rounded-md" placeholder="https://docs.google.com/spreadsheets/d/...">
                 </div>
                 <div>
                     <label for="gemini-api-key" class="block text-sm font-medium text-gray-700">Gemini API Key (Hanya disimpan di browser Anda)</label>
                     <input type="password" id="gemini-api-key" class="mt-1 w-full px-3 py-2 border rounded-md" placeholder="Masukkan API Key Gemini Anda">
                 </div>
                 <div>
                     <label for="apps-script-url" class="block text-sm font-medium text-gray-700">URL Google Apps Script (Untuk Hasil)</label>
                     <input type="text" id="apps-script-url" class="mt-1 w-full px-3 py-2 border rounded-md" placeholder="https://script.google.com/macros/s/.../exec">
                 </div>
             </div>
             <div class="mt-6 flex justify-end space-x-3">
                 <button id="generate-link-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Buat Link Ujian</button>
                 <button id="save-api-key-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Simpan API Key Lokal</button>
             </div>
             
             <div id="generated-link-container" class="hidden mt-4">
                 <label class="block text-sm font-medium text-gray-700">Link Ujian (Bagikan ke Siswa):</label>
                 <textarea id="generated-link-output" class="w-full h-24 p-2 border rounded-md mt-1 bg-gray-50" readonly></textarea>
                 <button id="copy-link-btn" class="mt-2 w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">Salin Link</button>
             </div>
             
              <div class="mt-4 border-t pt-4">
                  <button id="reset-settings-btn" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Reset Pengaturan Lokal</button>
                  <p class="text-xs text-gray-500 text-center mt-2">Hanya mereset API Key yang tersimpan di browser ini.</p>
              </div>
        </div>
        </div>
    
    <div id="cheat-backdrop" class="modal-backdrop"></div>
    <div id="cheat-modal" class="modal w-11/12 max-w-md bg-white rounded-xl shadow-2xl p-6 text-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-red-500" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" />
        </svg>
        <h3 class="text-xl font-bold text-gray-800 mt-4">Ujian Dihentikan!</h3>
        <p class="text-gray-600 mt-2">Aktivitas di luar jendela ujian terdeteksi. Sesuai peraturan, ujian Anda telah dihentikan secara otomatis.</p>
        <button id="close-cheat-modal-btn" class="mt-6 w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700">Lihat Hasil</button>
    </div>

    <div id="pdf-render-area"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const TEACHER_PIN = "1234";

    // --- Element Selectors ---
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const resultsScreen = document.getElementById('results-screen');
    const startQuizBtn = document.getElementById('start-quiz-btn');
    const studentNameInput = document.getElementById('student-name');
    const studentClassInput = document.getElementById('student-class');
    const examSubjectInput = document.getElementById('exam-subject');
    const startError = document.getElementById('start-error');
    
    const questionCounter = document.getElementById('question-counter');
    const studentInfo = document.getElementById('student-info');
    const questionText = document.getElementById('question-text');
    const studentAnswerInput = document.getElementById('student-answer');
    const submitAnswerBtn = document.getElementById('submit-answer-btn');
    const gradingLoader = document.getElementById('grading-loader');
    const writingToolbar = document.getElementById('writing-toolbar');
    const timerDisplay = document.getElementById('timer-display');

    const resultStudentName = document.getElementById('result-student-name');
    const resultClassSubject = document.getElementById('result-class-subject');
    const totalScoreEl = document.getElementById('total-score');
    const resultsDetails = document.getElementById('results-details');
    const retakeQuizBtn = document.getElementById('retake-quiz-btn');
    const downloadPdfBtn = document.getElementById('download-pdf-btn');
    const saveStatus = document.getElementById('save-status');

    const teacherSettingsBtn = document.getElementById('teacher-settings-btn');
    const settingsBackdrop = document.getElementById('settings-backdrop');
    const settingsModal = document.getElementById('settings-modal');
    const pinSection = document.getElementById('pin-section');
    const teacherPinInput = document.getElementById('teacher-pin');
    const submitPinBtn = document.getElementById('submit-pin-btn');
    const pinError = document.getElementById('pin-error');
    const settingsSection = document.getElementById('settings-section');
    const closeSettingsBtn = document.getElementById('close-settings-btn');
    const teacherNameInput = document.getElementById('teacher-name');
    const examMaterialInput = document.getElementById('exam-material');
    const examDurationInput = document.getElementById('exam-duration');
    const sheetUrlInput = document.getElementById('sheet-url');
    const geminiApiKeyInput = document.getElementById('gemini-api-key');
    const appsScriptUrlInput = document.getElementById('apps-script-url');
    const resetSettingsBtn = document.getElementById('reset-settings-btn');
    
    // --- SELEKTOR BARU UNTUK PANEL GURU ---
    const generateLinkBtn = document.getElementById('generate-link-btn');
    const saveApiKeyBtn = document.getElementById('save-api-key-btn');
    const generatedLinkContainer = document.getElementById('generated-link-container');
    const generatedLinkOutput = document.getElementById('generated-link-output');
    const copyLinkBtn = document.getElementById('copy-link-btn');
    
    const cheatBackdrop = document.getElementById('cheat-backdrop');
    const cheatModal = document.getElementById('cheat-modal');
    const closeCheatModalBtn = document.getElementById('close-cheat-modal-btn');
    
    // --- State Variables ---
    let questions = [];
    let currentQuestionIndex = 0;
    let studentName = "", studentClass = "", examSubject = "";
    let studentAnswers = [];
    
    // --- PENGATURAN DEFAULT (FALLBACK) ---
    // Ini hanya dipakai jika siswa membuka link TANPA parameter
    let settings = { 
        sheetUrl: "https://docs.google.com/spreadsheets/d/1XvwgOUD0DM1kMWKHbOfqkuckY7vIW5_E94sENKprnb0/edit", 
        geminiApiKey: "AIzaSyApredwnbrUDIJWuIUf3ykLbyDi8Qqt7N8", 
        appsScriptUrl: "https://script.google.com/macros/s/AKfycbxF__BjdvtfdfXLEkjLFzMjPk-mJu7IXcuuARUOh3ZkBvZF_OhwDilDzuTfm1x7sbpwdQ/exec", 
        teacherName: 'Sofiyan Hadi, S.Si.',
        examMaterial: 'Ujian Default', 
        examDuration: '30'
    };
    let isQuizActive = false;
    let timerInterval = null;

    // --- Helper Function ---
    const parseSheetUrl = (url) => {
        try {
            if (!url) return null;
            const match = url.match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            return match ? match[1] : null;
        } catch (error) { return null; }
    };

    // --- Settings Management (FUNGSI INI DIUBAH TOTAL) ---
    const loadSettings = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const sheetIdFromUrl = urlParams.get('sheetId');
        const scriptUrlFromUrl = urlParams.get('scriptUrl');
        // --- TAMBAHAN BARU ---
        const teacherFromUrl = urlParams.get('teacher');
        const materialFromUrl = urlParams.get('material');
        const durationFromUrl = urlParams.get('duration');
        // --- AKHIR TAMBAHAN ---

        let activeSettings = { ...settings }; // Mulai dengan fallback settings

        // Timpa dengan data dari localStorage (HANYA API KEY)
        const savedSettingsJSON = localStorage.getItem('quizAppSettings');
        if (savedSettingsJSON) {
            const savedSettings = JSON.parse(savedSettingsJSON);
            activeSettings.geminiApiKey = savedSettings.geminiApiKey || activeSettings.geminiApiKey;
        }
        
        // --- BAGIAN YANG DIUBAH TOTAL ---
        // Timpa dengan data dari URL jika ada (prioritas tertinggi untuk ujian)
        if (sheetIdFromUrl) {
            activeSettings.sheetUrl = `https://docs.google.com/spreadsheets/d/${sheetIdFromUrl}/edit`;
            // Jika link ini adalah link ujian (ada sheetId),
            // kita PAKSA pengaturan lain dari URL juga
            if (scriptUrlFromUrl) activeSettings.appsScriptUrl = decodeURIComponent(scriptUrlFromUrl);
            if (teacherFromUrl) activeSettings.teacherName = decodeURIComponent(teacherFromUrl);
            if (materialFromUrl) activeSettings.examMaterial = decodeURIComponent(materialFromUrl);
            if (durationFromUrl) activeSettings.examDuration = durationFromUrl;
            
            // LANGSUNG ISI FORM SISWA DAN KUNCI (READONLY)
            examSubjectInput.value = activeSettings.examMaterial || '';
            examSubjectInput.readOnly = true;
        }
        // --- AKHIR PERUBAHAN ---
        
        settings = activeSettings;

        // Tampilkan pengaturan yang aktif ke dalam form panel GURU
        // (Biarkan fallback URL/data tampil di panel guru jika link siswa dibuka)
        sheetUrlInput.value = settings.sheetUrl || '';
        appsScriptUrlInput.value = settings.appsScriptUrl || '';
        geminiApiKeyInput.value = settings.geminiApiKey || '';
        teacherNameInput.value = settings.teacherName || '';
        examMaterialInput.value = settings.examMaterial || '';
        examDurationInput.value = settings.examDuration || '30';
    };

    // --- FUNGSI 'saveSettings' DIGANTI DENGAN FUNGSI-FUNGSI BARU INI ---

    // Fungsi untuk menyimpan API Key saja secara lokal
    const saveApiKeyLocal = () => {
        const settingsToSave = {
            geminiApiKey: geminiApiKeyInput.value,
        };
        localStorage.setItem('quizAppSettings', JSON.stringify(settingsToSave));
        settings.geminiApiKey = geminiApiKeyInput.value; // Perbarui state saat ini
        alert('API Key berhasil disimpan di browser ini!');
    };

    // Fungsi untuk membuat link ujian
    const generateExamLink = () => {
        const sheetUrl = sheetUrlInput.value;
        const sheetId = parseSheetUrl(sheetUrl);
        const scriptUrl = appsScriptUrlInput.value;
        const teacher = teacherNameInput.value;
        const material = examMaterialInput.value;
        const duration = examDurationInput.value;

        if (!sheetId || !scriptUrl || !teacher || !material) {
            alert('Harap isi semua kolom untuk membuat link (Sheet URL, Script URL, Nama Guru, Materi).');
            return;
        }

        const baseUrl = window.location.href.split('?')[0];
        const params = new URLSearchParams();
        params.append('sheetId', sheetId);
        params.append('scriptUrl', encodeURIComponent(scriptUrl));
        params.append('teacher', encodeURIComponent(teacher));
        params.append('material', encodeURIComponent(material));
        if (duration) {
            params.append('duration', duration);
        }

        const generatedLink = `${baseUrl}?${params.toString()}`;
        
        generatedLinkOutput.value = generatedLink;
        generatedLinkContainer.style.display = 'block';
    };

    // Fungsi untuk menyalin link
    const copyLinkToClipboard = () => {
        generatedLinkOutput.select(); // Pilih teks di textarea
        try {
            // Cara modern (lebih aman)
            navigator.clipboard.writeText(generatedLinkOutput.value)
                .then(() => {
                    alert('Link berhasil disalin!');
                })
                .catch(err => {
                    // Fallback jika gagal
                    console.error('Gagal menyalin (modern): ', err);
                    document.execCommand('copy');
                    alert('Link berhasil disalin! (fallback)');
                });
        } catch (err) {
            // Fallback untuk browser sangat lama / non-HTTPS
            console.error('Gagal menyalin (fallback): ', err);
            document.execCommand('copy');
            alert('Link berhasil disalin! (fallback)');
        }
    };

    // FUNGSI resetLocalSettings DIMODIFIKASI
    const resetLocalSettings = () => {
        if(confirm('Apakah Anda yakin ingin mereset API Key yang tersimpan di browser ini?')) {
            localStorage.removeItem('quizAppSettings');
            alert('API Key lokal berhasil direset. Halaman akan dimuat ulang.');
            window.location.reload();
        }
    };

    const openSettingsModal = () => {
        // Saat modal dibuka, pastikan area link tersembunyi lagi
        generatedLinkContainer.style.display = 'none';
        generatedLinkOutput.value = '';
        
        settingsBackdrop.style.display = 'block';
        settingsModal.style.display = 'block';
        pinSection.style.display = 'block';
        settingsSection.style.display = 'none';
        teacherPinInput.value = '';
        pinError.textContent = '';
    };

    const closeSettingsModal = () => {
        settingsBackdrop.style.display = 'none';
        settingsModal.style.display = 'none';
    };

    const checkPin = () => {
        if (teacherPinInput.value === TEACHER_PIN) {
            pinSection.style.display = 'none';
            settingsSection.style.display = 'block';
        } else {
            pinError.textContent = 'PIN salah. Coba lagi.';
        }
    };

    // --- Exam Security, Timer, and Core Logic (Tidak ada perubahan di sini) ---
    const handleCheatingAttempt = () => {
        if (!isQuizActive) return;
        isQuizActive = false; 
        removeRestrictionListeners();
        cheatBackdrop.style.display = 'block';
        cheatModal.style.display = 'block';
        // Langsung tampilkan hasil, meskipun mungkin kosong jika belum ada jawaban
        showResults(); 
    };
    const handleVisibilityChange = () => {
        if (document.hidden && isQuizActive) {
            handleCheatingAttempt();
        }
    };
    const addRestrictionListeners = () => {
        window.addEventListener('blur', handleCheatingAttempt);
        document.addEventListener('visibilitychange', handleVisibilityChange);
    };
    const removeRestrictionListeners = () => {
        window.removeEventListener('blur', handleCheatingAttempt);
        document.removeEventListener('visibilitychange', handleVisibilityChange);
    };
    const startTimer = () => {
        if (timerInterval) clearInterval(timerInterval);
        const durationInMinutes = parseInt(settings.examDuration, 10);
        if (!durationInMinutes || durationInMinutes <= 0) {
            timerDisplay.textContent = 'Tanpa Waktu';
            return;
        }
        let timeLeftInSeconds = durationInMinutes * 60;
        const updateDisplay = () => {
            if (timeLeftInSeconds < 0) return;
            const minutes = Math.floor(timeLeftInSeconds / 60);
            const seconds = timeLeftInSeconds % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeftInSeconds <= 60 && timeLeftInSeconds > 0) {
                timerDisplay.classList.add('animate-pulse');
            } else {
                timerDisplay.classList.remove('animate-pulse');
            }
        };
        updateDisplay();
        timerInterval = setInterval(() => {
            timeLeftInSeconds--;
            updateDisplay();
            if (timeLeftInSeconds < 0) {
                clearInterval(timerInterval);
                timerDisplay.textContent = "Waktu Habis!";
                showResults();
            }
        }, 1000);
    };
    const fetchQuestions = async () => {
        if (!settings.sheetUrl || !settings.geminiApiKey) {
            startError.textContent = 'Pengaturan aplikasi belum lengkap.';
            return false;
        }
        
        // FUNGSI parseSheetUrl SEKARANG MENGACU KE FUNGSI GLOBAL DI ATAS
        const sheetId = parseSheetUrl(settings.sheetUrl);
        if (!sheetId) {
            startError.textContent = 'Format URL Google Sheet tidak valid.';
            return false;
        }
        const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&cb=${new Date().getTime()}`;
        try {
            startQuizBtn.disabled = true;
            startQuizBtn.textContent = 'Memuat Soal...';
            const response = await fetch(csvUrl);
            if (!response.ok) throw new Error('Gagal mengambil data. Pastikan sheet sudah di-"publish ke web" (Opsi 1: Seluruh Dokumen) DAN akses link diatur ke "Siapa saja yang memiliki link".');
            const csvText = await response.text();
            const rows = csvText.split(/\r?\n/).slice(1);
            questions = rows.map(row => {
                if (!row) return null;
                const columns = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                return {
                    question: (columns[0] || '').replace(/^"|"$/g, '').trim(),
                    keyAnswer: (columns[1] || '').replace(/^"|"$/g, '').trim()
                };
            }).filter(q => q && q.question);
            if (questions.length === 0) throw new Error('Tidak ada soal yang ditemukan.');
            // Acak soal
            for (let i = questions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [questions[i], questions[j]] = [questions[j], questions[i]];
            }
            return true;
        } catch (error) {
            startError.textContent = error.message;
            return false;
        } finally {
            startQuizBtn.disabled = false;
            startQuizBtn.textContent = 'Mulai Ujian';
        }
    };
    const startQuiz = async () => {
        studentName = studentNameInput.value.trim();
        studentClass = studentClassInput.value.trim();
        // examSubject diambil dari input, yang sudah diisi oleh loadSettings
        examSubject = examSubjectInput.value.trim(); 
        if (!studentName || !studentClass || !examSubject) {
            startError.textContent = 'Semua kolom identitas harus diisi.';
            return;
        }
        startError.textContent = '';
        const questionsLoaded = await fetchQuestions();
        if (!questionsLoaded) return;
        isQuizActive = true;
        addRestrictionListeners();
        currentQuestionIndex = 0;
        studentAnswers = [];
        startScreen.classList.add('hidden');
        resultsScreen.classList.add('hidden');
        quizScreen.classList.remove('hidden');
        displayQuestion();
        startTimer();
    };
    const displayQuestion = () => {
        const currentQuestion = questions[currentQuestionIndex];
        questionCounter.textContent = `Soal ${currentQuestionIndex + 1} dari ${questions.length}`;
        studentInfo.innerHTML = `Siswa: <strong>${studentName}</strong><br>Kelas: <strong>${studentClass}</strong>`;
        questionText.textContent = currentQuestion.question;
        studentAnswerInput.value = '';
        studentAnswerInput.focus();
    };
    const gradeAnswer = async (question, keyAnswer, studentAnswer) => {
        const apiKey = settings.geminiApiKey;
        // Ganti URL API jika model yang Anda gunakan berbeda
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
        
        const systemPrompt = "Anda adalah seorang asisten guru AI yang cerdas dan objektif. Tugas Anda adalah menilai jawaban esai siswa berdasarkan kunci jawaban atau rubrik yang diberikan. Berikan skor dari 0 hingga 100 dan berikan umpan balik singkat dan konstruktif. Jawaban Anda HARUS dalam format JSON.";
        const userQuery = `Soal: "${question}"\n\nKunci Jawaban/Rubrik: "${keyAnswer}"\n\nJawaban Siswa: "${studentAnswer}"\n\nBerdasarkan informasi di atas, berikan skor dan umpan balik singkat.`;

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            generationConfig: {
                responseMimeType: "application/json",
                // Ini adalah skema yang DILARANGKAN. Gemini akan *mencoba* mengikutinya.
                responseSchema: {
                    type: "OBJECT",
                    properties: { 
                        score: { type: "NUMBER" }, 
                        feedback: { type: "STRING" } 
                    },
                    required: ["score", "feedback"]
                }
            }
        };

        try {
            const response = await fetch(apiUrl, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(payload) 
            });
            if (!response.ok) { 
                const err = await response.json(); 
                throw new Error(`API Error: ${err.error.message}`); 
            }
            const result = await response.json();
            // Perlu parsing JSON dari teks yang dikembalikan
            return JSON.parse(result.candidates[0].content.parts[0].text);
        } catch (error) {
            console.error("Error saat menghubungi Gemini API:", error);
            // Coba lagi tanpa skema JSON jika gagal (mungkin karena API Key lama/model lama)
            return await gradeAnswerFallback(question, keyAnswer, studentAnswer);
        }
    };

    // Fallback jika model tidak support JSON mode
    const gradeAnswerFallback = async (question, keyAnswer, studentAnswer) => {
        console.warn("Menjalankan Fallback grading (tanpa JSON mode)");
        const apiKey = settings.geminiApiKey;
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
        
        const prompt = `Anda adalah asisten guru AI. Berikan penilaian untuk jawaban siswa berdasarkan soal dan kunci jawaban.
        Soal: "${question}"
        Kunci Jawaban: "${keyAnswer}"
        Jawaban Siswa: "${studentAnswer}"

        Berikan jawaban HANYA dalam format JSON berikut:
        {"score": [skor 0-100], "feedback": "[umpan balik singkat]"}`;

        const payload = {
            contents: [{ parts: [{ text: prompt }] }]
        };

        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) { const err = await response.json(); throw new Error(`API Error: ${err.error.message}`); }
            const result = await response.json();
            
            // Ekstrak JSON dari teks
            let textResponse = result.candidates[0].content.parts[0].text;
            textResponse = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
            return JSON.parse(textResponse);
        } catch (error) {
             console.error("Error saat Fallback grading:", error);
             return { score: 0, feedback: "Terjadi kesalahan ganda saat mengoreksi." };
        }
    };

    const submitAnswer = async () => {
        const studentAnswer = studentAnswerInput.value.trim();
        if (studentAnswer.length < 3) {
            alert("Jawaban Anda terlalu singkat.");
            return;
        }

        submitAnswerBtn.disabled = true;
        gradingLoader.classList.remove('hidden');

        const currentQuestion = questions[currentQuestionIndex];
        const result = await gradeAnswer(currentQuestion.question, currentQuestion.keyAnswer, studentAnswer);

        studentAnswers.push({
            ...currentQuestion,
            studentAnswer: studentAnswer,
            score: result.score,
            feedback: result.feedback
        });

        currentQuestionIndex++;
        submitAnswerBtn.disabled = false;
        gradingLoader.classList.add('hidden');

        if (currentQuestionIndex < questions.length) {
            displayQuestion();
        } else {
            showResults();
        }
    };
    const showResults = () => {
        isQuizActive = false;
        removeRestrictionListeners();
        if (timerInterval) clearInterval(timerInterval);

        quizScreen.classList.add('hidden');
        resultsScreen.classList.remove('hidden');

        let totalScore = 0;
        resultsDetails.innerHTML = '';

        if (studentAnswers.length === 0) {
            // Kasus jika siswa curang sebelum menjawab 1 soal pun
            totalScoreEl.textContent = "0";
            resultsDetails.innerHTML = '<p class="text-center text-red-500">Tidak ada jawaban yang tersimpan.</p>';
            saveStatus.textContent = "Ujian dihentikan, tidak ada data untuk disimpan.";
        } else {
            studentAnswers.forEach((result, index) => {
                totalScore += result.score;
                const scoreColor = result.score >= 75 ? 'text-green-600' : (result.score >= 50 ? 'text-yellow-600' : 'text-red-600');
                
                resultsDetails.innerHTML += `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold text-gray-800">Soal ${index + 1}</h4>
                            <span class="font-bold text-lg ${scoreColor}">${result.score}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2"><strong>Soal:</strong> ${result.question}</p>
                        <p class="text-sm text-gray-800 mb-2"><strong>Jawaban Anda:</strong> ${result.studentAnswer || "<i>(Tidak dijawab)</i>"}</p>
                        <p class="text-sm text-blue-700 bg-blue-50 border border-blue-200 rounded p-2"><strong>Umpan Balik AI:</strong> ${result.feedback}</p>
                    </div>
                `;
            });
            
            const averageScore = Math.round(totalScore / studentAnswers.length);
            totalScoreEl.textContent = averageScore;
            saveResultsToSheet(averageScore);
        }

        resultStudentName.textContent = studentName;
        resultClassSubject.textContent = `${studentClass} - ${examSubject}`;
    };
    const saveResultsToSheet = async (averageScore) => {
        if (!settings.appsScriptUrl) {
            saveStatus.textContent = 'URL Apps Script tidak diatur. Hasil tidak disimpan.';
            return;
        }
        
        saveStatus.textContent = 'Menyimpan hasil ke Google Sheet...';
        const payload = {
            timestamp: new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' }),
            studentName,
            studentClass,
            examSubject,
            averageScore,
            teacherName: settings.teacherName,
            examMaterial: settings.examMaterial,
            answers: JSON.stringify(studentAnswers) // Kirim semua data jawaban
        };

        try {
            const response = await fetch(settings.appsScriptUrl, {
                method: 'POST',
                mode: 'no-cors', // Penting untuk Apps Script
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });
            // Karena 'no-cors', kita tidak bisa membaca responsnya.
            // Kita asumsikan berhasil jika tidak ada error.
            saveStatus.textContent = 'Hasil berhasil disimpan ke Google Sheet!';
            saveStatus.classList.remove('text-red-500');
            saveStatus.classList.add('text-green-600');
        } catch (error) {
            console.error('Error saving to sheet:', error);
            saveStatus.textContent = 'Gagal menyimpan hasil. Cek konsol.';
            saveStatus.classList.remove('text-green-600');
            saveStatus.classList.add('text-red-500');
        }
    };
    const downloadPDF = async () => {
        const { jsPDF } = window.jspdf;
        const pdfRenderArea = document.getElementById('pdf-render-area');
        
        // 1. Buat HTML untuk PDF
        let pdfHTML = `
            <style>
                body { font-family: 'Inter', sans-serif; font-size: 10pt; }
                h1 { font-size: 18pt; font-weight: bold; text-align: center; color: #333; margin-bottom: 5px; }
                h2 { font-size: 14pt; font-weight: bold; text-align: center; color: #555; margin-top: 0; margin-bottom: 20px; }
                .meta-table { width: 100%; margin-bottom: 20px; border-collapse: collapse; }
                .meta-table td { padding: 5px; font-size: 10pt; }
                .meta-table td:first-child { font-weight: bold; width: 100px; }
                .score-box { text-align: center; margin-bottom: 20px; }
                .score-box p { margin: 0; font-size: 11pt; color: #444; }
                .score-box h3 { margin: 0; font-size: 48pt; font-weight: bold; color: #0056b3; }
                .result-item { margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; padding: 10px; page-break-inside: avoid; }
                .result-item h4 { font-size: 11pt; font-weight: bold; margin: 0 0 8px 0; padding-bottom: 5px; border-bottom: 1px solid #eee; }
                .result-item .q { font-weight: bold; margin-bottom: 5px; }
                .result-item .a { margin-bottom: 8px; }
                .result-item .f { font-style: italic; color: #0056b3; background: #f0f7ff; padding: 5px; border-radius: 3px; }
                .footer { text-align: right; font-size: 9pt; color: #777; margin-top: 20px; }
            </style>
            <h1>Laporan Hasil Ujian</h1>
            <h2>${examSubject}</h2>
            
            <table class="meta-table">
                <tr><td>Nama Siswa</td><td>: ${studentName}</td></tr>
                <tr><td>Kelas</td><td>: ${studentClass}</td></tr>
                <tr><td>Materi</td><td>: ${settings.examMaterial}</td></tr>
                <tr><td>Guru</td><td>: ${settings.teacherName}</td></tr>
                <tr><td>Tanggal</td><td>: ${new Date().toLocaleString('id-ID')}</td></tr>
            </table>

            <div class="score-box">
                <p>Skor Rata-rata</p>
                <h3>${totalScoreEl.textContent}</h3>
            </div>

            <hr style="border: 0; border-top: 1px solid #ccc; margin-bottom: 20px;">
        `;

        studentAnswers.forEach((result, index) => {
            pdfHTML += `
                <div class="result-item">
                    <h4>Soal ${index + 1} (Skor: ${result.score})</h4>
                    <p class="q"><strong>Soal:</strong> ${result.question}</p>
                    <p class="a"><strong>Jawaban:</strong> ${result.studentAnswer || "<i>(Tidak dijawab)</i>"}</p>
                    <p class="f"><strong>Umpan Balik:</strong> ${result.feedback}</p>
                </div>
            `;
        });
        
        pdfHTML += `<p class="footer">Dicetak dari Aplikasi Ujian Esai AI</p>`;

        pdfRenderArea.innerHTML = pdfHTML;
        
        // 2. Gunakan html2canvas untuk merender HTML
        downloadPdfBtn.textContent = 'Membuat PDF...';
        downloadPdfBtn.disabled = true;
        
        try {
            const canvas = await html2canvas(pdfRenderArea, {
                scale: 2, // Resolusi lebih tinggi
                useCORS: true,
                logging: false
            });
            
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: 'a4'
            });

            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const imgWidth = canvas.width;
            const imgHeight = canvas.height;
            const ratio = imgHeight / imgWidth;
            
            const canvasHeightInMM = pdfWidth * ratio;
            let- position = 0;
            let- pageHeight = pdfHeight - 20; // margin 10mm top/bottom
            
            pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, canvasHeightInMM - 20);
            
            let heightLeft = canvasHeightInMM - 20 - pageHeight;
            
            while (heightLeft > 0) {
                position = -(pageHeight * (pdf.internal.getNumberOfPages()));
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 10, position + 10, pdfWidth - 20, canvasHeightInMM - 20);
                heightLeft -= pageHeight;
            }

            pdf.save(`Hasil Ujian - ${studentName} - ${examSubject}.pdf`);

        } catch (error) {
            console.error("Error generating PDF:", error);
            alert("Gagal membuat PDF. Coba lagi.");
        } finally {
            downloadPdfBtn.textContent = 'Unduh Hasil (PDF)';
            downloadPdfBtn.disabled = false;
            pdfRenderArea.innerHTML = ''; // Kosongkan lagi
        }
    };
    
    // --- Event Listeners ---
    startQuizBtn.addEventListener('click', startQuiz);
    submitAnswerBtn.addEventListener('click', submitAnswer);
    retakeQuizBtn.addEventListener('click', () => {
        window.location.reload();
    });
    downloadPdfBtn.addEventListener('click', downloadPDF);

    teacherSettingsBtn.addEventListener('click', openSettingsModal);
    closeSettingsBtn.addEventListener('click', closeSettingsModal);
    settingsBackdrop.addEventListener('click', closeSettingsModal);
    submitPinBtn.addEventListener('click', checkPin);
    teacherPinInput.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') submitPinBtn.click();
    });
    closeCheatModalBtn.addEventListener('click', () => {
        cheatBackdrop.style.display = 'none';
        cheatModal.style.display = 'none';
    });

    // --- LISTENER TOMBOL BARU ---
    generateLinkBtn.addEventListener('click', generateExamLink);
    saveApiKeyBtn.addEventListener('click', saveApiKeyLocal);
    copyLinkBtn.addEventListener('click', copyLinkToClipboard);
    resetSettingsBtn.addEventListener('click', resetLocalSettings);

    // Toolbar karakter khusus
    writingToolbar.addEventListener('click', (e) => {
        if (e.target.classList.contains('toolbar-btn')) {
            const char = e.target.dataset.char;
            const start = studentAnswerInput.selectionStart;
            const end = studentAnswerInput.selectionEnd;
            const text = studentAnswerInput.value;
            studentAnswerInput.value = text.substring(0, start) + char + text.substring(end);
            studentAnswerInput.focus();
            studentAnswerInput.setSelectionRange(start + 1, start + 1);
        }
    });

    // --- Inisialisasi ---
    loadSettings();
});
</script>
</body>
</html>